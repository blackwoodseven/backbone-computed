
/*
 * -------------------------------------------------------
 * Project: Backbone Computed
 * Version: 0.0.4
 *
 * Author:  Blackwood Seven A/S
 * Site:     http://www.blackwoodseven.com
 * Contact: 
 *
 *
 * Copyright (c) 2014 Blackwood Seven A/S
 * -------------------------------------------------------
 */

!function(root,factory){"object"==typeof exports?module.exports=factory():"function"==typeof define&&define.amd?define([],factory):root.BackboneComputed=factory()}(this,function(){var BackboneComputed={VERSION:"0.0.4"};return BackboneComputed.mixin={get:function(attr,options){var parent,computedAttr;if(parent=this.parent?this.parent:Backbone.Model.prototype.get,options=options||{},options.ignoreComputed)return parent.apply(this,arguments);if(this.computed&&attr in this.computed){if(computedAttr=this.computed[attr],_.isFunction(computedAttr))return computedAttr.apply(this);if(_.isObject(computedAttr)&&computedAttr.get)return computedAttr.get.apply(this)}return parent.apply(this,arguments)},set:function(attr,value,options){var parent,attrs,settings,unset,changes,changing,prev,current;if(settings=BackboneComputed.settings,parent=this.parent?this.parent:Backbone.Model.prototype.set,"object"==typeof attr?(attrs=attr,options=value):(attrs={})[attr]=value,options=options||{},options.ignoreComputed||!this.computed)return parent.apply(this,arguments);if(unset=options.unset,silent=options.silent,changes=[],changing=this._changing,this._changing=!0,changing||(this._previousAttributes=_.clone(this.attritbutes||{}),this.changed={}),current=this.attributes,prev=this._previousAttributes,_.each(attrs,function(value,attr){var computedAttr,currentValue;value instanceof Backbone.Collection&&(this.stopListening(this.get("attr")),this.listenTo(value,"add remove reset sort",this.propagateCollectionEvent)),attr in this.computed&&(computedAttr=this.computed[attr],_.isObject(computedAttr)&&computedAttr.set&&(computedAttr.set.call(this,value,options),currentValue=this.get(attr),_.isEqual(currentValue,value)||(changes.push(attr),this.changed[attr]=value,current[attr]=value,this.attributes[attr]=value)))},this),parent.apply(this,arguments),!silent){changes.length&&(this._pending=options);for(var i=0,l=changes.length;l>i;i++)this.trigger("change:"+changes[i],this,current[changes[i]],options)}if(changing)return this;if(!silent)for(;this._pending;)options=this._pending,this._pending=!1,this.trigger("change",this,options),this.triggerComputed(options);return this._pending=!1,this._changing=!1,this},propagateCollectionEvent:function(){var collection,attr,collectionChanged;collection=arguments[0]instanceof Backbone.Model?arguments[1]:arguments[0],_.each(this.attributes,function(value,key){value===collection&&(attr=key)}),attr?(collectionChanged={},collectionChanged[attr]=collection,this.triggerComputed({changed:collectionChanged,externalEvent:!0})):this.stopListening(collection)},triggerComputed:function(options){var changed,computedChanged={},depsChanged={},opts=options||{};changed=opts.externalEvent?opts.changed:this.changedAttributes(),changed&&(this._buildDependencyHash(),depsChanged=_.pick(this._dependencyHash,_.keys(changed)),_.each(depsChanged,function(value){var computedList=value;_.each(computedList,function(computedAttr){computedChanged[computedAttr]=this.get(computedAttr)},this)},this),_.extend(this.changed,computedChanged),_.each(computedChanged,function(value,key){this.trigger("change:"+key,this,value,{})},this))},_buildDependencyHash:function(){this._dependencyHash||(this._dependencyHash={},_.each(this.computed,function(cattr,key){_.isObject(cattr)&&_.has(cattr,"deps")&&_.each(cattr.deps,function(dep){_.has(this._dependencyHash,dep)||(this._dependencyHash[dep]=[]),this._dependencyHash[dep].push(key)},this)},this))}},BackboneComputed});