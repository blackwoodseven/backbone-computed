
/*
 * -------------------------------------------------------
 * Project: Backbone Computed
 * Version: 0.0.2
 *
 * Author:  Blackwood Seven A/S
 * Site:     http://www.blackwoodseven.com
 * Contact: 
 *
 *
 * Copyright (c) 2014 Blackwood Seven A/S
 * -------------------------------------------------------
 */

!function(root,factory){"object"==typeof exports?module.exports=factory():"function"==typeof define&&define.amd?define([],factory):root.BackboneComputed=factory()}(this,function(){var BackboneComputed={VERSION:"0.0.2"};return BackboneComputed.mixin={get:function(attr,options){var parent,computedAttr;if(parent=this.parent?this.parent:Backbone.Model.prototype.get,options=options||{},options.ignoreComputed)return parent.apply(this,arguments);if(attr in this.computed){if(computedAttr=this.computed[attr],_.isFunction(computedAttr))return computedAttr.apply(this);if(_.isObject(computedAttr)&&computedAttr.get)return computedAttr.get.apply(this)}return parent.apply(this,arguments)},set:function(attr,value,options){var parent,attrs,settings;return settings=BackboneComputed.settings,parent=this.parent?this.parent:Backbone.Model.prototype.set,"object"==typeof attr?(attrs=attr,options=value):(attrs={})[attr]=value,options=options||{},options.ignoreComputed||!this.computed?parent.apply(this,arguments):(_.each(attrs,function(value,attr){var computedAttr,currentValue;value instanceof Backbone.Collection&&(this.stopListening(this.get("attr")),this.listenTo(value,"add remove reset sort",this.propagateCollectionEvent)),attr in this.computed&&(computedAttr=this.computed[attr],_.isObject(computedAttr)&&computedAttr.set&&(computedAttr.set.call(this,value,options),currentValue=this.get(attr),_.isEqual(currentValue,value)||(this.changed[attr]=value,options.silent||this.trigger("change:"+attr,this,value,options))))},this),parent.apply(this,arguments),void this.triggerComputed())},propagateCollectionEvent:function(){var collection,attr,collectionChanged;collection=arguments[0]instanceof Backbone.Model?arguments[1]:arguments[0],_.each(this.attributes,function(value,key){value===collection&&(attr=key)}),attr?(collectionChanged={},collectionChanged[attr]=collection,this.triggerComputed({changed:collectionChanged,externalEvent:!0})):this.stopListening(collection)},triggerComputed:function(options){var changed,computedChanged={},depsChanged={},opts=options||{};changed=opts.externalEvent?opts.changed:this.changedAttributes(),changed&&(this._buildDependencyHash(),depsChanged=_.pick(this._dependencyHash,_.keys(changed)),_.each(depsChanged,function(value){var computedList=value;_.each(computedList,function(computedAttr){computedChanged[computedAttr]=this.get(computedAttr)},this)},this),_.extend(this.changed,computedChanged),_.each(computedChanged,function(value,key){this.trigger("change:"+key,this,value,{})},this))},_buildDependencyHash:function(){this._dependencyHash||(this._dependencyHash={},_.each(this.computed,function(cattr,key){_.isObject(cattr)&&_.has(cattr,"deps")&&_.each(cattr.deps,function(dep){_.has(this._dependencyHash,dep)||(this._dependencyHash[dep]=[]),this._dependencyHash[dep].push(key)},this)},this))}},BackboneComputed});